<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Coffee Profit Treemap</title>
 <script src="jquery-1.8.3.min.js"></script>
        <link rel="stylesheet" type="text/css" href="format.css"/>
<script type="text/javascript" src="d3/d3.js">
</script>
<link type="text/css" rel="stylesheet" href="format.css"/>
</head>
<style>
.node {
  border: solid 1px white;
  font: 30px sans-serif;
  line-height: 40px;
  overflow: hidden;
  position: absolute;
}
.node:hover{

  border:solid 1px black;
  float: right;
  z-index:5;


}

#tooltip {
position: absolute;
width: auto;
height: auto;
padding: 10px;
background-color: orange;
-webkit-border-radius: 10px;
-moz-border-radius: 10px;
border-radius: 10px;
-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4); 
-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4); 
box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
 pointer-events: none;
 z-index:2;
 opacity: 0.9;
text-align:center;
}
#tooltip.hidden {
display: none;
}
#tooltip p { 
  margin: 0;
font-family: sans-serif; font-size: 15px; line-height: 15px;
}
</style>

<body>



<div ID="top" ><p>Homework4-Fan Jingxian</p></div>
    <div ID="left"></div>
     <div ID="right"></div>
     <div ID="middle">   
      <h1>Coffee Treemap </h1>
   <br /><br />

<script src="http://d3js.org/d3.v3.min.js"></script>
<div class="Homework4">
<script>
		var color = d3.scale.category10();

		var width=960;
		var height=500;

		var nest=[];
		var treemap=[];
		var nodes=[];
		var nest1=[];
		var state;
		var region;
	d3.csv("coffee.csv",function(dataset){ 

		 nest= d3.nest()
		 		.key(function(){return "root";})
				.key(function(d) { return d.region; })
				.key(function(d) { return d.state; })
				.entries(dataset);

		

		treemap = d3.layout.treemap()
			    .size([width, height])
			    .sticky(true)
			    .children(function(d) {return d.values})
			    .value(function(d) { return d.profit; })
			    .nodes(nest[0]);

		


		var title=d3.select(".Homework4")
					.append("div")
					.text("HW4")
					.style("margin-left","12%")
					.style("margin-top","0px")
					.style("text-align","center")
					.style("margin-bottom","0px")
					.style("position","relative")
					.style("font-size","35px")
					.style("width","960px")
					.style("height","100px");

		var title2=d3.select(".Homework4")
					.append("div")
					.style("margin-left","50%")
					.style("margin-top","0px")
					.style("margin-bottom","0px")
					.style("position","relative")
					.style("font-size","20px");

		var title3=d3.select(".Homework4")
					.append("div")
					.style("margin-left","12%")
					.style("margin-top","0px")
					.style("margin-bottom","0px")
					.style("position","relative")
					.style("font-size","20px");

		var div=d3.select('.Homework4')
					.append("div")
					.style("width",width+"px")
					.style("height",20+"px")
					.style("margin","auto")
					.style("margin-top","10px")
					.style("opacity", .9)
					.style("position","relative")
					.style("background","orange")
					.text("Click Here Back")
					.style("cursor","pointer")
					.style("font-size","15px")
					.style("color","black")
					.style("text-align","center")
					.on("click",function(){

									node=div.selectAll(".node").remove();

											treemap = d3.layout.treemap()
												    .size([width, height])
												    .sticky(true)
												    .children(function(d) {return d.values})
												    .value(function(d) { return d.profit; })
												    .nodes(nest[0]);

									node = div.selectAll(".node")
								      .data(treemap.filter(function(d){ return d.depth===1 || d.depth===2}))
								      .enter()
								      .append("div")
								      .attr("class", "node")
								      .call(position)
								      .style("background", function(d) { 							
								      	if (d.depth==2)
								      		return color(d.parent.key);
								      	else return color(d.key);
								      })
								      .style("opacity",function(d){
								      	if(d.depth==1) return 0.8;
								      	else return 1;
								      })
								      .style("z-index",function(d){
								      	if(d.depth==2) return 1;
								      	else return 2;
								      })
								      .text(function(d){

								      	if(d.depth==1)return d.key;})
								      .style("text-align","center")
								      .style("cursor","pointer")
								      .call(onclick_region)
								      .call(tooltip);


					   });


		var div=d3.select('.Homework4')
					.append("div")
					.style("width",width+"px")
					.style("height",height+"px")
					.style("margin","auto")
					.style("margin-top","5px")
					.style("opacity", .9)
					.style("position","relative")
					.attr("class","treemap");


		  var node = div.selectAll(".node")
				      .data(treemap.filter(function(d){ return d.depth===1 || d.depth===2}))
				      .enter()
				      .append("div")
				      .attr("class", "node")
				      .call(position)
				      .style("background", function(d) { 							
				      	if (d.depth==2)
				      		return color(d.parent.key);
				      	else return color(d.key);
				      })
				      .style("opacity",function(d){
				      	if(d.depth==1) return 0.8;
				      	else return 1;
				      })
				      .style("z-index",function(d){
				      	if(d.depth==2) return 1;
				      	else return 2;
				      })
				      .text(function(d){

				      	if(d.depth==1)return d.key;})
				      .style("text-align","center")
				      .style("cursor","pointer")
				      .call(tooltip)
					  .call(onclick_region);

				function position() {
			  		this.style("left", function(d) { return d.x + "px"; })
			      		.style("top", function(d) { return d.y + "px"; })
			      		.style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
			     		.style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
									}


				function onclick_region(){
						this.on("click",function(d){

					   		 region=d.key;
					   		

					   			nest1 = d3.nest()
							 		.key(function(){return "root";})
									.key(function(d) { return d.state; })
									.entries(dataset.filter(function(a){return a.region==region;}));

								

								var	treemap1 = d3.layout.treemap()
												    .size([width, height])
												    .sticky(true)
												    .children(function(d) {return d.values})
												    .value(function(d) { return d.profit;
												    .nodes(nest1[0]);

												   

									node=div.selectAll(".node").remove();

							
									node = div.selectAll(".node")
								      .data(treemap1.filter(function(d){ return d.depth===1 || d.depth===2}))
								      .enter()
								      .append("div")
								      .attr("class", "node")
								      .call(position)
								      .style("background", function(d) { 							
								      	if (d.depth==2)
								      		return color(d.parent.key);
								      	else return color(d.key);
								      })
								      .style("opacity",function(d){
								      	if(d.depth==1) return 0.9;
								      	else return 1;
								      })
								      .style("z-index",function(d){
								      	if(d.depth==2) return 1;
								      	else return 2;
								      })
								      .text(function(d){

								      	if(d.depth==1)return d.key;})
								      .style("text-align","center")
								      .style("cursor","pointer")
								      .call(tooltip)
								      .call(onclick_state);

					   });

				}

					function onclick_state(){
						this.on("click",function(d){

					   		 state=d.key;
				

					   		var	nest2 = d3.nest()
									.key(function(d) { return d.state; })
									.key(function(d) { return d.date; })
									.entries(dataset.filter(function(a){return a.state==state && a.region==region;}));

							

								var	treemap1 = d3.layout.treemap()
												    .size([width, height])
												    .sticky(true)
												    .children(function(d) {return d.values})
												    .value(function(d) { return d.profit; })
												    .nodes(nest2[0]);

										

									node=div.selectAll(".node").remove();

							
									node = div.selectAll(".node")
								      .data(treemap1.filter(function(d){ return d.depth===1}))
								      .enter()
								      .append("div")
								      .attr("class", "node")
								      .call(position)
								      .style("background", function(d) {  return color(d.key);})
								      .text(function(d){ return d.key;})
								      .style("font-size","15px")
								      .style("text-align","center")
								      .call(tooltip);

					   });

				}




				function tooltip(){
					this.on("mouseover", function(d) {

							var xPosition = d.x+300;
							var yPosition = d.y+350;
							

								d3.select("#tooltip")
							      .style("left", xPosition + "px")
							      .style("top", yPosition + "px")
							      .select("#value")
								  .html(function(){
								  	{return   d.key +"<br>"+ "Profit:" + d.value ;}
									
									})
								d3.select("#tooltip").classed("hidden", false);
								});


					 this.on("mouseout", function() { 
			         			d3.select("#tooltip").classed("hidden", true);
			     			});




				}







		});


</script>
</div>
</div>
</body>
</html>
